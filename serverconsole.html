<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>console</title>
    <style>
        .console_text{
            font-family:'Consolas','Menlo','Noto Mono','Courier New', Courier, monospace;
            color:white;
            word-wrap: break-word;
        }
    </style>
<link rel="stylesheet" type="text/css" href="console.css">
<link rel="stylesheet" type="text/css" href="basicWidgets.css">
<script src="lib/cookie.js"></script>
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="popups.js"></script>
<script src="DLSProtocol.js"></script>
<script src="ansi2html.js"></script>
<script src="serverconsole.js"></script>
<script src="panel.js"></script>
<script>
//网页加载完毕才加载的部分
$(()=>{
//如果使用DLSProtocol则打开ws
if(isDLSProtocol())refreshWSConnection(localStorage.getItem("host"))
let userInputContent=""
//清空网页加载时莫名其妙出现的一堆tab
document.getElementById('command').value=userInputContent;
let pointerInHistory=0;
//检测return/enter键
$(document).on('keypress',function(e) {
	//后面要检测ctrl+enter换行
    //检测到目前聚焦在输入框上才能发送
    if(e.which == 13&&document.getElementById('command')==document.activeElement) {
		executeCustomCmd(document.getElementById('command'),e)
        //清空所有指令输入框中的内容
		setTimeout(()=>document.getElementById('command').value="",30)
        //重置用户输入的内容
        userInputContent=""
        //发送时把指针设置为历史命令尾部之后以重置状态
        pointerInHistory=customCmdHistory.length;
    }
});
$(document).on('keydown', function(e) {
    //检测到上下键时调用历史命令
    if([38,40].includes(e.which)&&document.getElementById('command')==document.activeElement){
        //如果用户从正在编辑的内容中离开，那么先记录他正编辑的内容再使用历史记录覆盖
        if(pointerInHistory>=customCmdHistory.length)userInputContent=document.getElementById('command').value
        switch(e.which){
            //上  
            case 38:
                //不是0了才向上移动，是0了就什么也不做，因为到顶了
                if(pointerInHistory>0)pointerInHistory--;
                break;
            case 40:
                //到底了就什么也不做
                if(pointerInHistory<customCmdHistory.length)pointerInHistory++;
                break;

        } 
        //修正过小或过大的指针
        if(pointerInHistory<0)pointerInHistory=0;
        if(pointerInHistory>customCmdHistory.length)pointerInHistory=customCmdHistory.length;
        //读取此处的历史记录，如果目前位于数组外，那么使用用户正输入的内容，如果位于数组内，那么使用历史记录
        if(pointerInHistory>=customCmdHistory.length)document.getElementById('command').value=userInputContent;
        else document.getElementById('command').value=customCmdHistory[pointerInHistory];
        //TODO:用户如果移动到历史记录时有编辑行为，那么立即将输入框内容记录为用户编辑内容，然后移动指针到末尾
    }

})
//更新顶部那排开关的状态
let switch_button=document.getElementById("switch_auto_scroll");
    switch_button.style["background-color"]=getConfObj("auto_scroll")?"#36f":"#b0c9f7";


//网页开始时才加载的部分结束
})
</script>
</head>
<body bgcolor="303030">
    <form class="executer">
        <textarea id="command" placeholder="输入控制台命令" class="command">
            
        </textarea>
        <button class="send_button" id="send" onclick="executeCustomCmd(document.getElementById('command'),event)">
            <img src="maps/send.png" class="send_button_image">
        </button>
    </form>
    <div class="console_toolbox">
        <button class="round_button" id="switch_auto_scroll" onclick="switch_auto_scroll()">
            <img src="maps/send.png" class="send_button_image">
        </button>
    </div>
    <div class="console_text">
        <p id="console_log"></p><br><br><br>
    </div>

</body>
</html>