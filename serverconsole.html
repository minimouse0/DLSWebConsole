<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>console</title>
    <style>
        .console_text{
            font-family:'Courier New', Courier, monospace;
            color:white;
        }
    </style>
<script src="lib/cookie.js"></script>
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script>
const host=parseCookie("host")
const token=parseCookie("token")

const console_color_table={
    "0":"white"
}

function scrollToBottom(){}
function defscroller(){
//æ–‡å¿ƒä¸€è¨€ç”Ÿæˆçš„è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€åº•éƒ¨çš„å‡½æ•°ï¼Œä¸ä¸€å®šå®Œå…¨èƒ½ç”¨
// è·å–å½“å‰æ–‡æ¡£å¯¹è±¡
let doc = document;
// åˆ¤æ–­æµè§ˆå™¨ç±»å‹å¹¶é€‰æ‹©ç›¸åº”çš„æ»šåŠ¨å‡½æ•°
if (doc.documentElement && doc.scrollTop) { // IE6+ã€Chromeã€Firefoxç­‰ç°ä»£æµè§ˆå™¨
    scrollToBottom=()=>{
        if (doc.body) {
            window.scroll(0, doc.body.offsetHeight);
        } else {
            // ç­‰å¾…bodyå…ƒç´ åŠ è½½å®Œæˆåå†æ»šåŠ¨
            setTimeout(scrollToBottom, 100);
        }
    }
} else if (doc.body.scrollLeft || doc.body.scrollTop) { // SafariåŠIE5/Macä¸Šçš„Quirksæ¨¡å¼
    scrollToBottom=()=>{
        if (doc.body) {
            window.scrollBy(0, doc.body.offsetHeight - window.innerHeight);
        } else {
            // ç­‰å¾…bodyå…ƒç´ åŠ è½½å®Œæˆåå†æ»šåŠ¨
            setTimeout(scrollToBottom, 100);
        }
    }
}
};
let wait_scroller=setInterval(()=>{
    let doc = document;
    if(doc.body||doc.scrollTop){
        defscroller();
        clearInterval(wait_scroller);
    }
},100);

let current_log_id=0;
/** åœ¨æµè§ˆå™¨ä¸­å­˜å‚¨çš„å®Œæ•´logåˆ—è¡¨ */
let logs=[];
let last_new_log=new Date();
function refresh_console(){
    let settings = {
        "url": host+"/terminal_log?token="+token+"&log_id="+current_log_id.toString(),
        "method": "GET",
        "timeout": 0,
        "beforeSend": (XMLHttpRequest)=>{
            XMLHttpRequest.setRequestHeader("Content-Type", "application/json");
        }
    };

    $.ajax(settings).done(function (response) {
        logs=merge_log(logs,response.log_list);
        //ç›´æ¥å°†æ•´ä¸ªæ§åˆ¶å°å†…å®¹æ›¿æ¢
        document.getElementById("console_log").innerHTML=parse_log(logs)
        //åˆ·æ–°æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå°†æ­¤æ¬¡åˆ·æ–°å¾—åˆ°çš„æœ€åä¸€ä¸ªlog idä¿å­˜
        if(response.log_list.length){//å¦‚æœåˆ—è¡¨é‡Œæœ‰ä¸œè¥¿è¯æ˜åˆšåˆšæœ‰æ–°è¾“å‡ºï¼Œåˆ·æ–°log idå’Œä¸Šæ¬¡æ–°logæ—¶é—´æˆ³
            last_new_log=new Date();
            current_log_id=response.log_list[response.log_list.length-1].log_id;
            //æœ‰æ–°è¾“å‡ºï¼Œåˆ·æ–°å®Œæˆåè‡ªåŠ¨æ»šåŠ¨åˆ°æ§åˆ¶å°åº•éƒ¨
            var height = document.body.scrollHeight;
            window.scroll({ top: height , left: 0})
        }
    });
}
//æ­¤å‡½æ•°ç”¨äºä¸‹é¢å‡½æ•°ä¸­æ–°æ—¥å¿—ä¸è¿ç»­çš„æƒ…å†µï¼Œå› ä¸ºæ—¥å¿—ä¸è¿ç»­ä¼šé€ æˆæ‹¼æ¥å‡ºç°é—®é¢˜
//æ— éœ€è€ƒè™‘æ—§æ—¥å¿—æ˜¯å¦æœ‰ä¸è¿ç»­çš„éƒ¨åˆ†ï¼Œç®—æ³•å†³å®šäº†æ—§æ—¥å¿—è¿ç»­æ€§ä¸å½±å“æ‹¼æ¥
function patch_new_log(){

}
function merge_log(logs,new_logs){
    /*æ—§æ—¥å¿—å°¾éƒ¨id logs[logs.length-1].log_id
    æ–°æ—¥å¿—å¤´éƒ¨id new_logs[new_logs.length-1].log_id
    éœ€è¦è®¡ç®—æ–°æ—§æ—¥å¿—é‡åˆçš„éƒ¨åˆ†
    è¿™ä¸ªéƒ¨åˆ†çš„é•¿åº¦ä¸ºæ—§æ—¥å¿—å°¾éƒ¨id-æ–°æ—¥å¿—å¤´éƒ¨id+1
    ç”±äºå¯èƒ½ä¸­é—´ä¼šä¸¢ä¸€éƒ¨åˆ†æ—¥å¿—å¯¼è‡´idä¸è¿ç»­ï¼Œé€ æˆé•¿åº¦ä¸ºè´Ÿï¼Œåé¢éœ€è¦å¯¹è´Ÿæ•°åšä¸€ä¸‹æ’é™¤
    å…·ä½“ç®—æ³•æ˜¯é•¿åº¦ä¸º0æˆ–è´Ÿåˆ™è¯æ˜æ—¥å¿—æ²¡æœ‰é‡åˆï¼Œç›´æ¥æ‹¼æ¥å³å¯
    è®¡ç®—å¥½æ—§æ—¥å¿—çš„é•¿åº¦ä¹‹åï¼Œå°†æ–°æ—¥å¿—å¤´éƒ¨å‰Šå»ç›¸åº”é•¿åº¦ï¼Œå³å¯å®Œç¾å¯¹æ¥
    å¦‚æœæ–°æ—¥å¿—è‡ªèº«é•¿åº¦å°äºç­‰äºé‡åˆé•¿åº¦ï¼Œåˆ™è¯æ˜å®Œå…¨æ²¡æœ‰å¿…è¦è¿›è¡Œæ‹¼æ¥
    */
    if(!new_logs.length){//å¦‚æœæ–°æ—¥å¿—é•¿åº¦æ˜¯ç©ºçš„ï¼Œè¯æ˜æ²¡æœ‰ä»»ä½•ä¸œè¥¿è¦æ‹¼æ¥ï¼Œç›´æ¥è¿”å›æ—§æ—¥å¿—
        return logs;
    }
    if(!logs.length){//å¦‚æœæ—§æ—¥å¿—é•¿åº¦æ˜¯ç©ºçš„ï¼Œè¯æ˜æ–°æ—¥å¿—æ˜¯ç¬¬ä¸€æ®µè¢«æ‹¼æ¥è¿›æ¥çš„æ—¥å¿—
        return new_logs;
    }
    let coincide_length=logs[logs.length-1].log_id-new_logs[new_logs.length-1].log_id+1;
    if(coincide_length>=0){
        return logs.concat(new_logs);
    }
    if(coincide_length>=new_logs.length){
        return logs;
    }
    new_logs.splice(0,coincide_length);
    return logs.concat(new_logs);
}

/**
 * å°†dlså‘å‡ºçš„å¸¦é¢œè‰²çš„è¾“å‡ºè½¬æ¢ä¸ºhtmlæ ¼å¼
 */
function color_html_convert(log){
        let color_text_html=""
        //æŠŠæ‰€æœ‰çš„\u001bå­—ç¬¦è½¬æ¢ä»¥ä¾¿åé¢æ“ä½œçš„æ—¶å€™ä¸€äº›å‡½æ•°èƒ½è¯†åˆ«
        //å‰é¢å’Œæœ«å°¾æ·»åŠ ä¸€ä¸ªç™½è‰²çš„é¢œè‰²ä»£ç æ–¹ä¾¿åé¢ä¸€æ¬¡æ€§åˆ†å‰²
        let color_text="\u001b[0m"+log.color_text+"\u001b[0m";
        //ç¬¬ä¸€æ­¥ï¼šæŠŠæ‰€æœ‰é¢œè‰²ä»£ç åˆ†ç‰‡
        let color_slices=color_text.split(/\u001b\[/)
        //ç¬¬äºŒæ­¥ï¼šæå–æ‰€æœ‰é¢œè‰²ä»£ç åé¢çš„å†…å®¹
        let color_slices_html=[]
        for(let color_slice of color_slices){
            //console.log(JSON.stringify(log.color_text));
            //å¦‚æœå½“å‰è¿™ä¸ªåˆ‡ç‰‡æ˜¯ç©ºçš„ï¼Œåé¢å°±æ— æ³•å¤„ç†ï¼Œè·³è¿‡
            if(color_slice=="")continue;
            //æå–åˆ‡ç‰‡å‰éƒ¨çš„é¢œè‰²ä»£ç 
            let color_code="0"
            let text=""
            if(color_slice.match(/(.+?)m/)){
                color_code=color_slice.match(/(.+?)m/)[1];
                //å»æ‰é¢œè‰²ä»£ç æå–æ–‡æœ¬
                text=color_slice.replace(color_code+"m","");
            }//å¦‚æœä¸Šé¢æ²¡æœ‰åŒ¹é…ï¼Œè¯æ˜ä¸å­˜åœ¨é¢œè‰²ä»£ç 
            else{
                color_code="0";
                text=color_slice;
            }
            //ç¬¬ä¸‰æ­¥ï¼šè§£æé¢œè‰²ä»£ç 
            let html_color=""
            let color_code_nums=color_code.split(";")
            //é€šè¿‡å­—ç¬¦çš„æ•°é‡åˆ¤æ–­å¦‚ä½•è§£æé¢œè‰²
            switch(color_code_nums.length){
                //äº”ä¸ªçš„æ˜¯ç›´æ¥ç”¨rgb
                case 5:{
                    html_color="#"+Number(color_code_nums[2]).toString(16)+Number(color_code_nums[3]).toString(16)+Number(color_code_nums[4]).toString(16)
                    break;
                }
                //1ä¸ªå­—ç¬¦è¿™ç§æƒ…å†µæˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€ï¼Œå°±å…ˆæ˜ å°„äº†
                case 1:{
                    switch(color_code_nums[0]){
                        case "1":
                        case "31":
                        case "91":html_color="red";break;
                        case "33":
                        case "93":html_color="yellow";break;
                        case "21":html_color="blue";break;
                        case "4":
                        case "37":
                        case "0":html_color="white";break;
                        //é»˜è®¤æƒ…å†µåœ¨æ§åˆ¶å°è¾“å‡ºé¢œè‰²ä»£ç ï¼Œæ–¹ä¾¿åç»­æ›´æ–°çš„æ—¶å€™é€šè¿‡ç”¨æˆ·åé¦ˆæ‰¾è§„å¾‹
                        default:
                            html_color="white";
                            console.warn("æœªè¯†åˆ«çš„é¢œè‰²ä»£ç ï¼š"+color_code_nums[0])
                            console.warn("ç›¸å…³çš„è¾“å‡ºå†…å®¹ï¼š"+color_slice)
                    }
                    break;
                }
                default:html_color="white";
            }
            //è¿™ä¸ªåˆ—è¡¨åªä»£è¡¨å½“å‰è¿™ä¸€è¡Œï¼Œè¿™ä¸€æ•´ä¸ªåˆ—è¡¨ç”¨äºç»™åé¢æ‹¼æ¥æˆhtmlç”¨
            color_slices_html=color_slices_html.concat({
                color:html_color,
                text
            });
        }
        //å°†æ‰€æœ‰é¢œè‰²ç‰‡æ®µæ•´åˆä¸ºä¸€è¡Œ
        let line=""
        for(let color_slice of color_slices_html){
            line=line+`<span style=color:${color_slice.color}>`+color_slice.text+"</span>"
        }
        return line;
}

//ç®€å•ç²—çˆ†åœ°æŠŠæ‰€æœ‰è¾“å‡ºä¿¡æ¯åˆåˆ°ä¸€èµ·ï¼Œåé¢æ‰“ç®—å¼ƒç”¨ï¼Œå› ä¸ºå¤ªğŸ’©äº†
function parse_log(logs){
    let log_raw_text="";
    for(log of logs){
        
        //æ‹¼æ¥å½“å‰è¡Œ
        //ä½¿ç”¨è½¬æ¢å‡½æ•°å°†å¸¦é¢œè‰²çš„è¾“å‡ºè½¬æ¢åå†æ˜¾ç¤º
        log_raw_text=log_raw_text+color_html_convert(log);
        //åœ¨æœ€ååŠ ä¸Šä¸€ä¸ªæ¢è¡Œç¬¦
        log_raw_text=log_raw_text+"<br>";

    }
    //æ·»åŠ ç©ºè¡Œæ¥ä¿è¯ä¸è¾“å‡ºä¸è¢«ä¸‹é¢è¾“å…¥æ¡†æŒ¡ä½
    log_raw_text=log_raw_text+"<br><br><br>";
    return log_raw_text;
}
setInterval(()=>{
    refresh_console();
    //å¦‚æœä¸Šæ¬¡è¾“å‡ºåœ¨1.3så†…ï¼Œå°±ä»¥æ¯ç§’5æ¬¡çš„é€Ÿåº¦å¿«é€Ÿè½®è¯¢ç›´è‡³ä¸Šæ¬¡è¾“å‡ºè¶…æ—¶ï¼Œå³æ£€æµ‹åˆ°æ–°è¾“å‡ºåˆ™ç«‹åˆ»æ´»è·ƒ1.5sç„¶åæ”¾æ…¢é€Ÿåº¦
    if(new Date().getTime()-last_new_log.getTime()<1300){
        let active_console=setInterval(()=>{
            refresh_console();
            if(new Date().getTime()-last_new_log.getTime()>1500){//ä¸€æ—¦ä¸Šæ¬¡è¾“å‡ºè¶…æ—¶ï¼Œç«‹åˆ»ç»“æŸè½®è¯¢
                clearInterval(active_console);
            }
        },200)
    }
},1000);
</script>
</head>
<body bgcolor="303030">
    <div class="console_text">
        <p id="console_log"></p>
    </div>

</body>
</html>